# .github/workflows/main.yml

name: Test, Build and Upload Release Package

on:
  release:
    types: [created]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['7.4', '8.0', '8.1', '8.2']

    name: Test with PHP ${{ matrix.php-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: composer:v2

      - name: Install Composer dependencies
        run: composer install --no-dev --prefer-dist

      - name: Validate composer.json
        run: composer validate --strict

      - name: Run PHP Linter
        run: find . -path ./vendor -prune -o -name "*.php" -type f -print0 | xargs -0 -n1 -P4 php -l

  build-release-package:
    needs: test # This job will only run if the 'test' job completes successfully
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      # 2. Get tag name
      - name: Get tag name
        run: |
          echo "TAG_NAME=${{ github.event.release.tag_name }}" >> $GITHUB_ENV

      # 3. Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          # Run on the minimum supported version for the build package
          php-version: '7.4' 
          tools: composer:v2

      # 4. Cache Composer dependencies
      # This step will cache the 'vendor' directory based on the hash of 'composer.lock'
      - name: Cache Composer dependencies
        id: cache-composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-7.4-composer-${{ hashFiles('composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-7.4-composer-

      # 5. Install Composer dependencies
      # The 'if' condition skips this step if the cache was a 100% match (cache-hit)
      - name: Install Composer dependencies
        if: steps.cache-composer.outputs.cache-hit != 'true'
        run: composer install --no-dev --optimize-autoloader

      # 6. Create the .tar.gz release package
      - name: Create release package
        run: |
          #
          PLUGIN_DIR_NAME="xenditPayment"
          TARBALL="${PLUGIN_DIR_NAME}-${TAG_NAME}.tar.gz"
          TARBALL_PATH="$RUNNER_TEMP/${TARBALL}"

          tar -czf "${TARBALL_PATH}" \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='cypress' \
            --exclude='tests' \
            --exclude='.gitignore' \
            --transform "s|^\.|${PLUGIN_DIR_NAME}|" \
            .

          echo "TARBALL=${TARBALL}" >> $GITHUB_ENV
          echo "TARBALL_PATH=${TARBALL_PATH}" >> $GITHUB_ENV

      # 7. Hitung hash MD5
      - name: Calculate MD5 hash for the package
        run: |
          MD5=$(md5sum $TARBALL_PATH | awk '{print $1}')
          echo "MD5 Hash: ${MD5}"
          echo "MD5=${MD5}" >> $GITHUB_ENV

      # 8. Upload the package to the release
      - name: Upload package to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload $TAG_NAME $TARBALL_PATH --clobber

      # 9. Update the release notes with the MD5 hash
      - name: Update release notes with MD5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_BODY="$(gh release view "$TAG_NAME" --json body --jq .body)"
          gh release edit $TAG_NAME --notes "$(
            printf '%s\n\n%s\n\n%s\n' \
            "${CURRENT_BODY}" \
            "## Download Verification" \
            "MD5 Hash for \`$TARBALL\`: \`$MD5\`"
          )"
